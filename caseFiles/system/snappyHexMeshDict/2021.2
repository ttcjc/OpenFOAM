/*--------------------------------*- C++ -*----------------------------------*\
  =========                 |
  \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox
   \\    /   O peration     | Website:  https://openfoam.org
    \\  /    A nd           | Version:  7
     \\/     M anipulation  |
\*---------------------------------------------------------------------------*/
FoamFile
{
	version		2.0;
	format		ascii;
	class		dictionary;
	object		snappyHexMeshDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

// Revision 2021.2
// Changes from previous revision: Added floor refinement for improved prism
//								   layer quality 

// Meshing Process Switches
castellatedMesh		true;
snap				true;
addLayers			true;

// Geometry and Refinement Volumes
geometry
{
	tunnelWalls
	{
		type	triSurfaceMesh;
		file	"Tunnel_Working_Section_9.408_Buffer.stl";
	}

	refinementFloorInner
	{
		type	triSurfaceMesh;
		file	"Refinement_Floor_Inner.stl";
	}

	refinementFloorOuter
	{
		type	triSurfaceMesh;
		file	"Refinement_Floor_Outer.stl";
	}

	// windsorBody
	// {
	// 	type	triSurfaceMesh;
	// 	file	"Windsor_Body_Square.stl";
	// }

	// windsorAxles
	// {
	// 	type	triSurfaceMesh;
	// 	file	"Windsor_Axles_sHM.stl";
	// }

	// windsorWheels
	// {
	// 	type	triSurfaceMesh;
	// 	file	"Windsor_Wheels.stl";
	// }

	refinementUnderbodyInnerA
	{
		type	searchableBox;
		min		(-0.59275 -0.2265 0);
		max		(-0.46675 0.2265 0.125);
	}

	refinementUnderbodyInnerB
	{
		type	searchableBox;
		min		(-0.46675 -0.2265 0);
		max		(0.51525 0.2265 0.18);
	}

	refinementUnderbodyOuterA
	{
		type	searchableBox;
		min		(-0.62475 -0.2585 0);
		max		(-0.46675 0.2585 0.125);
	}

	refinementUnderbodyOuterB
	{
		type	searchableBox;
		min		(-0.46675 -0.2585 0);
		max		(0.405 0.2585 0.18);
	}

	refinementWake
	{
		type	searchableBox;
		min		(0.405 -0.2585 0);
		max		(1.28325 0.2585 0.403);
	}

	refinementLocal
	{
		type	searchableBox;
		min		(0.405 -0.3225 0);
		max		(2.08325 0.3225 0.467);
	}

	refinementFarField
	{
		type	searchableBox;
		min		(-1.15575 -0.4505 0);
		max		(3.68325 0.4505 0.595);
	}
}

// Mesh Control
castellatedMeshControls
{
	maxLocalCells 				20000000; 				// Per processor
	maxGlobalCells				120000000;				// Prior to geometry removal
	maxLoadUnbalance			0.1; 					// Fraction of perfect balance
	minRefinementCells			0; 						// Cells refined per iteration
	nCellsBetweenLevels			1; 						// Layers between levels
	gapLevelIncrement			0;						// Increase refinement level in small gaps
	resolveFeatureAngle			30; 					// Max refinement above balue
	locationInMesh				(0.3 0 0.66);			// Outside desired body
	allowFreeStandingZoneFaces	true;

	features	// Edge refinement based on surfaceFeatures utility
	(
		// {file "Windsor_Body_Square.eMesh";			level 5;}
		// {file "Windsor_Axles_sHM.eMesh";			level 5;}
		// {file "Windsor_Wheels.eMesh";				level 5;}
	);

	refinementSurfaces	// Surface refinement
	{
		refinementFloorInner
		{
			level	(4 4);	// Min and max level
		}

		refinementFloorOuter
		{
			level	(3 3);
		}

		// windsorBody
		// {
		// 	level	(5 5);
		// }

		// windsorAxles
		// {
		// 	level	(5 5);
		// }

		// windsorWheels
		// {
		// 	level	(5 5);
		// }
	}

	refinementRegions	// Volumetric refinement
	{
		tunnelWalls
		{
			mode	distance;
			levels	((0.048 2) (0.128 1));	// Distance from surface and level
		}

		// "(windsor.*)"
		// {
		// 	mode	distance;
		// 	levels	((0.012 5) (0.032 4) (0.064 3) (0.128 2) (0.256 1));
		// }

		"(refinementUnderbodyInner.*)"
		{
			mode	inside;
			levels	((1 4));	// First entry ignored
		}

		"(refinementUnderbodyOuter.*|refinementWake)"
		{
			mode	inside;
			levels	((1 3));
		}

		refinementLocal
		{
			mode	inside;
			levels	((1 2));
		}

		refinementFarField
		{
			mode	inside;
			levels	((1 1));
		}
	}
}

// Geometry Snap Control
snapControls
{
	tolerance				4;		// Rel. dist for point to snap
	nSmoothPatch			5;		// Surface smoothing iterations
	nSmoothInternal			5;		// Reduces surface non-orthogonality
	nRelaxIter				10;		// Improves snapping
	nFeatureSnapIter		10;		// Improves edge features
	nSolveIter				50;		// Snapping iterations
	implicitFeatureSnap		false;	// Use geometric features
	explicitFeatureSnap		true;	// Use eMesh features
	multiRegionFeatureSnap	false;	// Detects features between multiple faces
}

// Prism Layer Control
addLayersControls
{
	relativeSizes				true;	// Relative or absolute
	expansionRatio				1;		// Overwritten by unique layer controls
	firstLayerThickness			1;		// Overwritten by unique layer controls
	minThickness				0;		// Below which layers collapse
	nGrow						0;		// Delays layer growth close to patches
	featureAngle 				180;	// Above which layers collapse
	nSmoothSurfaceNormals 		5;
	nSmoothNormals 				5;
	nSmoothThickness 			10;
	maxFaceThicknessRatio 		5;		// Stop on warped cells
	maxThicknessToMedialRatio	1;
	minMedianAxisAngle 			90;
	nBufferCellsNoExtrude 		0;		// Gradually step down layer count
	nLayerIter 					100;	// Layer iterations
	nRelaxedIter				100;	// After which relaxed values used
	nRelaxIter 					100;	// Relaxed layer iterations

	layers
	{
		"(inletBuffer.*|workingSection.*|outletBuffer.*)"
	    {
			firstLayerThickness		0.07761;
			minThickness			0.07761;
			expansionRatio			1.3;
			nSurfaceLayers			9;
	    }

		refinementFloorInner
		{
			firstLayerThickness		0.31044;
			minThickness			0.31044;
			expansionRatio			1.3;
			nSurfaceLayers			4;
		}

		refinementFloorOuter
		{
			firstLayerThickness		0.15522;
			minThickness			0.15522;
			expansionRatio			1.3;
			nSurfaceLayers			7;
		}

		// "(windsor.*)"
		// {
		// 	firstLayerThickness		0.526;
		// 	minThickness			0.526;
		// 	expansionRatio			1.3;
		// 	nSurfaceLayers			2;
		// }
	}
}

// Quality Control
meshQualityControls
{
	maxNonOrtho			70;
	maxBoundarySkewness	5;
	maxInternalSkewness	4;
	maxConcave			80;
	minFlatness			0.5;
	minVol				1e-13;
	minTetQuality		1e-30;
	minArea				1e-13;
	minTwist			0.02;
	minDeterminant		0.001;
	minFaceWeight		0.05;
	minVolRatio			0.01;
	minTriangleTwist	-1;
	nSmoothScale		4;
	errorReduction		0.75;

	relaxed
	{
	}
}

mergeTolerance	1e-8;

// Mesh Evaluation
writeFlags
(
	scalarLevels
	layerSets
	layerFields
);

debug			0;

// ************************************************************************* //
